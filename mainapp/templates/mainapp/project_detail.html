{% extends 'mainapp/navbar_footer.html' %}
{% load static %}

{% block title %}{{ project.title }} - Ecopath{% endblock %}

{% block extra_head %}
<!-- GSAP for hero carousel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
    /* Hero Section Styles (mirroring project_list.html) */
    .hero-slide {
        opacity: 0;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    .text-shadow {
        text-shadow: 0px 2px 8px rgba(0, 0, 0, 0.5);
    }

    .hero-dot {
        background-color: rgba(255, 255, 255, 0.3);
        transition: background-color 0.3s ease;
    }

    .hero-dot.active {
        background-color: rgba(255, 255, 255, 1);
    }

    .hero-nav-item-slot {
        display: inline-block;
    }

    .hero-nav-group {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        opacity: 0;
    }

    /* Carousel Styles */
    .carousel-slide {
        transition: opacity 0.5s ease-in-out;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
</style>

{# Per-project meta tags #}
{% if project.meta_description %}
<meta name="description" content="{{ project.meta_description }}">
{% endif %}
{% if project.meta_keywords %}
<meta name="keywords" content="{{ project.meta_keywords }}">
{% endif %}
{% endblock %}

{% block content %}
<!-- Hero Carousel Section (reused from project_list, with dynamic images) -->
<section class="relative h-screen w-full overflow-hidden pt-12">
    <!-- Slides Container -->
    <div id="carousel-slides" class="h-full w-full relative">
        {% with images=project.gallery_images.all %}
        {% if images %}
        {% for image in images %}
        <div class="carousel-slide absolute inset-0 w-full h-full {% if not forloop.first %}opacity-0{% endif %}"
            data-index="{{ forloop.counter0 }}" style="background-image: url('{{ image.image.url }}');">
        </div>
        {% endfor %}
        {% else %}
        {# Fallback slide if no gallery images are defined #}
        <div class="carousel-slide absolute inset-0 w-full h-full" data-index="0"
            style="background-image: url('{% static 'images/Project 1 image.webp' %}');">
        </div>
        {% endif %}
        {% endwith %}
    </div>

    <!-- Navigation Arrows -->
    <button id="prev-btn"
        class="absolute left-4 md:left-8 top-1/2 -translate-y-1/2 z-10 bg-black/30 hover:bg-black/50 text-white p-3 rounded-full transition-all duration-300 focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </button>
    <button id="next-btn"
        class="absolute right-4 md:right-8 top-1/2 -translate-y-1/2 z-10 bg-black/30 hover:bg-black/50 text-white p-3 rounded-full transition-all duration-300 focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>

    <!-- Dots Navigation -->
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-10 flex space-x-3">
        {% with images=project.gallery_images.all %}
        {% if images %}
        {% for image in images %}
        <button
            class="dot-btn w-3 h-3 rounded-full bg-white/30 hover:bg-white/50 transition-all duration-300 focus:outline-none"
            data-index="{{ forloop.counter0 }}"></button>
        {% endfor %}
        {% else %}
        <button
            class="dot-btn w-3 h-3 rounded-full bg-white hover:bg-white/80 transition-all duration-300 focus:outline-none"
            data-index="0"></button>
        {% endif %}
        {% endwith %}
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const slides = document.querySelectorAll('.carousel-slide');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const dotBtns = document.querySelectorAll('.dot-btn');

        if (!slides.length) return;

        let currentSlide = 0;
        const totalSlides = slides.length;
        let slideInterval;
        const slideDuration = 5000; // 5 seconds

        // Initialize first slide
        updateSlide(0);
        startSlideShow();

        // Navigation functions
        function goToSlide(index) {
            currentSlide = (index + totalSlides) % totalSlides;
            updateSlide(currentSlide);
            resetSlideShow();
        }

        function goToNext() {
            goToSlide(currentSlide + 1);
        }

        function goToPrev() {
            goToSlide(currentSlide - 1);
        }

        // Update slide visibility and active states
        function updateSlide(index) {
            // Update slides
            slides.forEach((slide, i) => {
                if (i === index) {
                    gsap.to(slide, { opacity: 1, duration: 0.5 });
                } else {
                    gsap.to(slide, { opacity: 0, duration: 0.5 });
                }
            });

            // Update dots
            dotBtns.forEach((dot, i) => {
                if (i === index) {
                    dot.classList.remove('bg-white/30', 'w-3');
                    dot.classList.add('bg-white', 'w-6');
                } else {
                    dot.classList.remove('bg-white', 'w-6');
                    dot.classList.add('bg-white/30', 'w-3');
                }
            });

            // Update current slide index
            currentSlide = index;
        }

        // Auto-play functionality
        function startSlideShow() {
            slideInterval = setInterval(goToNext, slideDuration);
        }

        function resetSlideShow() {
            clearInterval(slideInterval);
            startSlideShow();
        }

        // Event Listeners
        prevBtn.addEventListener('click', () => {
            goToPrev();
        });

        nextBtn.addEventListener('click', () => {
            goToNext();
        });

        dotBtns.forEach(dot => {
            dot.addEventListener('click', () => {
                const slideIndex = parseInt(dot.getAttribute('data-index'));
                goToSlide(slideIndex);
            });
        });

        // Pause on hover (on the hero section only)
        const carousel = document.querySelector('section');
        if (carousel) {
            carousel.addEventListener('mouseenter', () => {
                clearInterval(slideInterval);
            });

            carousel.addEventListener('mouseleave', () => {
                resetSlideShow();
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                goToPrev();
            } else if (e.key === 'ArrowRight') {
                goToNext();
            }
        });
    });
</script>

<!-- Project Content Section -->
<section class="pt-24 pb-12 bg-white">
    <div class="container mx-auto max-w-5xl px-6">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-product-sans text-custom-green leading-tight">
            {{ project.title }}
        </h1>

        <p class="mt-4 font-montserrat text-[1.1rem] md:text-xl text-gray-700 leading-relaxed">
            {{ project.brief_description }}
        </p>

        <div class="project-content mt-8 font-montserrat text-lg text-gray-700 leading-relaxed
            [&_h1]:font-product-sans [&_h1]:font-black [&_h1]:text-3xl [&_h1]:text-custom-green [&_h1]:mt-8 [&_h1]:mb-4
            [&_h2]:font-product-sans [&_h2]:font-black [&_h2]:text-2xl [&_h2]:text-custom-green [&_h2]:mt-8 [&_h2]:mb-4
            [&_h3]:font-product-sans [&_h3]:font-bold [&_h3]:text-xl [&_h3]:text-custom-green [&_h3]:mt-6 [&_h3]:mb-3
            [&_p]:mb-6 [&_p]:leading-relaxed
            [&_ul]:list-disc [&_ul]:pl-5 [&_ul]:mb-6
            [&_ol]:list-decimal [&_ol]:pl-5 [&_ol]:mb-6
            [&_li]:mb-2
            [&_img]:rounded-xl [&_img]:shadow-lg [&_img]:my-8 [&_img]:w-full">
            {{ project.detail_content|safe }}
        </div>
    </div>
</section>

<script>
    // Attach Tailwind classes to headings, paragraphs, AND IMAGES inside the project content
    (function () {
        const mapping = {
            'H1': 'text-3xl md:text-4xl font-product-sans font-black my-6',
            'H2': 'text-2xl md:text-3xl font-product-sans font-black my-5',
            'H3': 'text-xl md:text-2xl font-product-sans font-black my-4',
            'H4': 'text-lg md:text-xl font-product-sans font-black my-3',
            'H5': 'text-base md:text-lg font-product-sans font-black my-2',
            'H6': 'text-sm md:text-base font-product-sans font-black my-2'
        };

        const container = document.querySelector('.project-content');
        if (!container) return;

        // 1. Format Headings
        const headings = container.querySelectorAll('h1,h2,h3,h4,h5,h6');
        headings.forEach(h => {
            const cls = mapping[h.tagName] || 'text-base font-product-sans font-black my-3';
            cls.split(' ').forEach(c => { if (c) h.classList.add(c); });
        });

        // 2. Format Paragraphs
        const paragraphs = container.querySelectorAll('p');
        paragraphs.forEach(p => {
            'my-4 text-base md:text-lg leading-relaxed'.split(' ').forEach(c => { if (c) p.classList.add(c); });
        });

        // 3. Format Images (Make them same size and look good)
        const images = container.querySelectorAll('img');
        const imageClasses = [
            'w-full',               // Full width of container
            'h-[400px]',            // Fixed height on mobile
            'md:h-[500px]',         // Fixed height on desktop
            'object-cover',         // Ensures image fills the box (crops edges if needed)
            'rounded-2xl',          // Nice rounded corners
            'shadow-lg',            // Depth shadow
            'my-10',                // Vertical spacing
            'block',                // Ensures it sits on its own line
            'mx-auto'               // Centers it
        ];

        images.forEach(img => {
            // Remove any inline styles that CKEditor might have added (optional, but recommended)
            img.style.height = ''; 
            img.style.width = '';
            
            imageClasses.forEach(c => img.classList.add(c));
        });

    })();
</script>

{% endblock %}